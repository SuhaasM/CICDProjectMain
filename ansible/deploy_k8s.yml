---
- name: Deploy LMS stack to Kubernetes (remote k3s)
  hosts: all
  become: true
  gather_facts: false
  vars:
    dockerhub_username: "your_dockerhub_username"
    image_tag: "latest"
    kubeconfig_path: "/etc/rancher/k3s/k3s.yaml"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  tasks:
    - name: Ensure Python3 is installed
      raw: |
        (command -v python3 >/dev/null 2>&1) || (sudo dnf install -y python3 || sudo yum install -y python3 || (sudo apt-get update && sudo apt-get install -y python3))

    - name: Ensure curl is installed
      raw: |
        (command -v curl >/dev/null 2>&1) || (sudo dnf install -y curl || sudo yum install -y curl || (sudo apt-get update && sudo apt-get install -y curl))

    - name: Set Python interpreter
      set_fact:
        ansible_python_interpreter: /usr/bin/python3

    - name: Install k3s (lightweight Kubernetes)
      shell: curl -sfL https://get.k3s.io | sh -
      args:
        creates: /etc/rancher/k3s/k3s.yaml

    - name: Create directory for Kubernetes manifests
      file:
        path: /opt/lms-k8s
        state: directory
        mode: '0755'

    - name: Copy Kubernetes manifests to remote
      copy:
        src: "{{ playbook_dir }}/../k8s/"
        dest: /opt/lms-k8s/
        mode: '0644'
        remote_src: false

    - name: Wait for Kubernetes API to be ready
      shell: kubectl get nodes --no-headers
      register: kubectl_nodes
      retries: 20
      delay: 6
      until: kubectl_nodes.rc == 0 and kubectl_nodes.stdout_lines | length > 0
      timeout: 150

    - name: Ensure Kubernetes namespace exists
      command: kubectl apply -f /opt/lms-k8s/namespace.yaml
      timeout: 30

    - name: Apply database secret
      command: kubectl apply -f /opt/lms-k8s/secret.yaml
      timeout: 30

    - name: Deploy MySQL
      command: kubectl apply -f /opt/lms-k8s/mysql-deployment.yaml
      timeout: 30

    - name: Expose MySQL service
      command: kubectl apply -f /opt/lms-k8s/mysql-service.yaml
      timeout: 30

    - name: Deploy backend
      command: kubectl apply -f /opt/lms-k8s/backend-deployment.yaml
      timeout: 30

    - name: Expose backend service
      command: kubectl apply -f /opt/lms-k8s/backend-service.yaml
      timeout: 30

    - name: Deploy frontend
      command: kubectl apply -f /opt/lms-k8s/frontend-deployment.yaml
      timeout: 30

    - name: Expose frontend service
      command: kubectl apply -f /opt/lms-k8s/frontend-service.yaml
      timeout: 30

    - name: Apply ingress
      command: kubectl apply -f /opt/lms-k8s/ingress.yaml
      timeout: 30

    - name: Remove nginx ingress class annotation for k3s (Traefik default)
      command: kubectl -n lms annotate ingress lms-ingress kubernetes.io/ingress.class-
      ignore_errors: true
      timeout: 30

    - name: Update backend image to Docker Hub username
      command: kubectl -n lms set image deployment/backend backend={{ dockerhub_username }}/cicdproject-backend:{{ image_tag }}
      timeout: 30

    - name: Update frontend image to Docker Hub username
      command: kubectl -n lms set image deployment/frontend frontend={{ dockerhub_username }}/cicdproject-frontend:{{ image_tag }}
      timeout: 30

    # CRITICAL FIX: Use shell with proper timeout and retry logic for long-running operations
    - name: Wait for backend rollout with retry
      shell: |
        set -e
        counter=0
        max_attempts=3
        while [ $counter -lt $max_attempts ]; do
          if kubectl -n lms rollout status deployment/backend --timeout=120s 2>/dev/null; then
            echo "Backend rollout successful"
            exit 0
          fi
          counter=$((counter + 1))
          if [ $counter -lt $max_attempts ]; then
            echo "Attempt $counter failed, retrying in 10s..."
            sleep 10
          fi
        done
        echo "Backend rollout failed after $max_attempts attempts"
        exit 1
      timeout: 420
      register: backend_rollout
      until: backend_rollout.rc == 0
      retries: 2
      delay: 5

    # CRITICAL FIX: Use shell with proper timeout and retry logic for long-running operations
    - name: Wait for frontend rollout with retry
      shell: |
        set -e
        counter=0
        max_attempts=3
        while [ $counter -lt $max_attempts ]; do
          if kubectl -n lms rollout status deployment/frontend --timeout=120s 2>/dev/null; then
            echo "Frontend rollout successful"
            exit 0
          fi
          counter=$((counter + 1))
          if [ $counter -lt $max_attempts ]; then
            echo "Attempt $counter failed, retrying in 10s..."
            sleep 10
          fi
        done
        echo "Frontend rollout failed after $max_attempts attempts"
        exit 1
      timeout: 420
      register: frontend_rollout
      until: frontend_rollout.rc == 0
      retries: 2
      delay: 5

    - name: Verify deployment status
      shell: kubectl -n lms get deployments -o wide
      register: deployment_status

    - name: Show deployment status
      debug:
        msg: "{{ deployment_status.stdout }}"